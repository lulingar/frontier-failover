<!DOCTYPE html>
<html lang="en">
<head>
    <title>Frontier Failover History</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="css/dc.css"/>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"/>
</head>

<body>

<script type="text/javascript" src="js/queue.v1.min.js"></script>
<script type="text/javascript" src="js/d3.js"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="js/dc.js"></script>
<script type="text/javascript" src="js/myutils.js"></script>

<div class="container">
    <h1>New Extended Frontier Failover history</h1>

    <div class="row">
        <div id="time-chart" class="dc-chart span6">
            <strong>Time:</strong>
            <small class="text-muted">
            <time id="date-start" datetime="2012-08-26 20:09-0700">8:09pm on August 26th, 2012</time> &ndash;
            <time id="date-end" datetime="2012-08-26 20:09-0700">8:09pm on August 26th, 2012</time>
            </small>
            <a class="reset" href="javascript:time_chart.filterAll(); dc.redrawAll();" style="display: none;">
                reset
            </a>

            <div class="clearfix"></div>
        </div>

    </div>

    <div class="row">
        <table class="table table-hover dc-data-table" id="hosts-table">
            <thead>
            <tr class="header">
                <th>Host</th>
                <th>Is Squid?</th>
                <th>Hits</th>
                <th>Last Visit</th>
                <th>Bandwidth</th>
            </tr>
            </thead>
        </table>
    </div>

</div> <!-- end container -->

<script type="text/javascript">

var time_chart = seriesBarChart("#time-chart"),
    hosts_table = dc.dataTable("#hosts-table"),
    width = time_chart.root()[0][0].parentElement.clientWidth;

var q = queue().defer(d3.json, "config.json")
               .defer(d3.csv, "test.csv");

q.await( function(error, config, dataset) {

    var period = config.history.period,
        periodObj = minuteBunch(period),
        periodRange = periodObj.range,
        now = new Date(),
        this_hour = periodObj(now).getTime(),
        extent_span = 3.6e6 * config.history.span,
        extent = [new Date(this_hour - extent_span), new Date(this_hour)],
        addH = function(p, d) { return p + d.Hits; },
        remH = function(p, d) { return p - d.Hits; },
        addR = function(p, d) { return p + d.HitsRate; },
        remR = function(p, d) { return p - d.HitsRate; },
        ini = function() { return 0; };

    dataset.forEach( function(d) {
        d.Timestamp = new Date(+d.Timestamp * 1000);
        d.Hits = +d.Hits;
        d.HitsRate = +d.HitsRate;
        d.Bandwidth = +d.Bandwidth;
        d.IsSquid = (d.IsSquid == "True");
    });

    console.log(dataset)

    var ndx = crossfilter(dataset),
        time = ndx.dimension( function(d) { return d.Timestamp; }),
        site = ndx.dimension( function(d) { return d.Sites; }),
        time_site = ndx.dimension(function(d) { return [d.Timestamp, d.Sites]; }),
        time_sites = time_site.group().reduce(addH, remH, ini),
        hits = ndx.dimension(function(d){ return d.Hits; }),
        hitsCounts = hits.group().reduce(addH, remH, ini),
        date_format = d3.time.format("%b %d, %Y %I:%M %p");

    d3.select("#date-start")
      .attr("datetime", extent[0])
      .text(date_format(extent[0]));
    d3.select("#date-end")
      .attr("datetime", extent[1])
      .text(date_format(extent[1]));

    time.filterRange(extent);

    time_chart
      .width(0.85 * width)
      .height(500)
      .margins({top: 100, right: 30, bottom: 30, left: 60})
      .dimension(time_site)
      .group(time_sites)
      .seriesAccessor(function(d) { return d.key[1]; })
      .keyAccessor(function(d) {return d.key[0];})
      .elasticY(true)
      .elasticX(true)
      .xAxisLabel("Time")
      .yAxisLabel("Hits")
      .x(d3.time.scale().domain(extent))
      .xUnits(periodRange)
      .renderHorizontalGridLines(true)
      .legend( dc.legend()
              .x(20).y(10)
              .itemHeight(13).itemWidth(150)
              .gap(5) )
      .seriesSort(d3.ascending)
      .brushOn(false);

    hosts_table.dimension(site)
               .group(function(d) { return d.Sites; })
               .columns([
                    function(d) { return d.Host; },
                    function(d) { return d.IsSquid; },
                    function(d) { return d.Hits; },
                    function(d) { return d['Last visit']; },
                    function(d) { return d.Bandwidth; }
                    ])
               .sortBy(function(d) { return d.IsSquid + d.Host; }); 

    dc.renderAll();
});

</script>
</body>
</html>
